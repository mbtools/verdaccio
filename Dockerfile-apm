#
# --- Build Stage ---
#
FROM --platform=${BUILDPLATFORM:-linux/amd64} node:24-alpine AS builder

ENV NODE_ENV=production \
    PNPM_VERSION=10.13.1 \
    VERDACCIO_BUILD_REGISTRY=https://registry.npmjs.org \
    VERDACCIO_BUILD_DIR=/opt/verdaccio-build

RUN apk add --force-overwrite && \
    apk --no-cache add openssl ca-certificates wget && \
    apk --no-cache add g++ gcc libgcc libstdc++ linux-headers make python3 && \
    wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub && \
    wget -q https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.35-r0/glibc-2.35-r0.apk && \
    apk add --force-overwrite glibc-2.35-r0.apk

WORKDIR $VERDACCIO_BUILD_DIR

RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate

# Copy only package files to benefit from Docker cache
COPY .babelrc ./
COPY pnpm-lock.yaml ./ 
COPY pnpm-workspace.yaml ./
COPY tsconfig.base.json ./
COPY tsconfig.reference.json ./
COPY package.json ./
COPY packages/ ./packages/

# Install all dependencies (workspace-aware)
RUN pnpm config set registry $VERDACCIO_BUILD_REGISTRY && \
    pnpm install --frozen-lockfile

# Build the repo
RUN pnpm run build

#
# --- Plugin Stage ---
#
FROM --platform=${BUILDPLATFORM:-linux/amd64} node:24-alpine AS plugins

ENV VERDACCIO_PLUGINS_DIR=/opt/verdaccio-plugins

WORKDIR $VERDACCIO_PLUGINS_DIR

COPY abappm/plugins/ ./

RUN cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/auth && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/filter && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/middleware && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/storage-proxy && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/storage-sql && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund

#
# --- Production Stage ---
#
FROM node:24-alpine AS app
LABEL maintainer="https://github.com/abapPM/abapPM"

ENV VERDACCIO_APP_DIR=/opt/verdaccio \
    VERDACCIO_BUILD_DIR=/opt/verdaccio-build \
    VERDACCIO_PLUGINS_DIR=/opt/verdaccio-plugins \
    VERDACCIO_USER_NAME=verdaccio \
    VERDACCIO_USER_UID=10001 \
    VERDACCIO_PORT=4873 \
    VERDACCIO_PROTOCOL=http
ENV PATH=$VERDACCIO_APP_DIR/docker-bin:$PATH \
    HOME=$VERDACCIO_APP_DIR

# https://github.com/Yelp/dumb-init
RUN apk --no-cache add openssl dumb-init

WORKDIR $VERDACCIO_APP_DIR

RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate

# Copy only package files to benefit from Docker cache
COPY .babelrc ./
COPY pnpm-lock.yaml ./ 
COPY pnpm-workspace.yaml ./
COPY tsconfig.base.json ./
COPY tsconfig.reference.json ./
COPY package.json ./
COPY packages/ ./packages/
COPY docker-bin/ ./docker-bin/

# Only install production dependencies (omit devDependencies)
RUN pnpm config set registry $VERDACCIO_BUILD_REGISTRY && \
    pnpm install --frozen-lockfile --prod --no-optional --ignore-scripts

# Clean up
RUN rm ./pnpm-lock.yaml ./pnpm-workspace.yaml && \
    rm -rf *.md

RUN find ./packages -type d -name "src" -o -name "test" -o -name "tests" | xargs rm -rf

# Copy build artifacts
COPY --from=builder $VERDACCIO_BUILD_DIR/packages.json ./
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/ ./packages/
COPY --from=builder $VERDACCIO_BUILD_DIR/docker-bin/ ./docker-bin/

# Prepare Verdaccio directories
RUN mkdir -p /verdaccio/storage /verdaccio/plugins /verdaccio/conf

# Copy plugins and config
COPY --from=plugins $VERDACCIO_PLUGINS_DIR /verdaccio/plugins
COPY abappm/conf /verdaccio/conf
COPY abappm/i18n $VERDACCIO_APP_DIR/packages/config/i18n/build/downloaded_translations

RUN adduser -u $VERDACCIO_USER_UID -S -D -h $VERDACCIO_APP_DIR -g "$VERDACCIO_USER_NAME user" -s /sbin/nologin $VERDACCIO_USER_NAME && \
    chmod -R +x $VERDACCIO_APP_DIR/packages/verdaccio/bin $VERDACCIO_APP_DIR/docker-bin && \
    chown -R $VERDACCIO_USER_UID:root /verdaccio/storage /verdaccio/plugins /verdaccio/conf && \
    chmod -R g=u /verdaccio/storage /verdaccio/plugins /verdaccio/conf /etc/passwd

USER $VERDACCIO_USER_UID

EXPOSE $VERDACCIO_PORT

VOLUME /verdaccio/storage

ENTRYPOINT ["uid_entrypoint"]

CMD $VERDACCIO_APP_DIR/packages/verdaccio/bin/verdaccio --config /verdaccio/conf/config.yaml --listen $VERDACCIO_PROTOCOL://0.0.0.0:$VERDACCIO_PORT
