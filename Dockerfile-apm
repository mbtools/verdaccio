#
# --- Build Stage ---
#
FROM --platform=${BUILDPLATFORM:-linux/amd64} node:24-alpine AS builder

ENV NODE_ENV=production \
    PNPM_VERSION=10.20.0 \
    VERDACCIO_BUILD_REGISTRY=https://registry.npmjs.org \
    VERDACCIO_BUILD_DIR=/opt/verdaccio-build

RUN apk add --force-overwrite && \
    apk --no-cache add openssl ca-certificates wget && \
    apk --no-cache add g++ gcc libgcc libstdc++ linux-headers make python3 && \
    wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub && \
    wget -q https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.35-r0/glibc-2.35-r0.apk && \
    apk add --force-overwrite glibc-2.35-r0.apk

WORKDIR $VERDACCIO_BUILD_DIR

RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate

# Copy only package files to benefit from Docker cache
COPY .babelrc ./
COPY pnpm-lock.yaml ./ 
COPY pnpm-workspace.yaml ./
COPY tsconfig.base.json ./
COPY tsconfig.reference.json ./
COPY package.json ./
COPY packages/ ./packages/

# Install all dependencies (workspace-aware)
RUN pnpm config set registry $VERDACCIO_BUILD_REGISTRY && \
    pnpm install --frozen-lockfile

# Build the repo
RUN pnpm run build

#
# --- Plugin Stage ---
#
FROM --platform=${BUILDPLATFORM:-linux/amd64} node:24-alpine AS plugins

ENV VERDACCIO_PLUGINS_DIR=/opt/verdaccio-plugins

WORKDIR $VERDACCIO_PLUGINS_DIR

COPY abappm/plugins/ ./

RUN cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/auth && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund --production && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/filter && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund --production && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/middleware && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund --production && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/storage-proxy && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund --production && \
    cd $VERDACCIO_PLUGINS_DIR/@verdaccio-pro/storage-sql && \
    npm install --install-strategy=shallow --no-bin-links --no-audit --no-fund --production

#
# --- Production Stage ---
#
FROM node:24-alpine AS app
LABEL maintainer="https://github.com/abapPM/abapPM"

ENV NODE_ENV=production \
    PNPM_VERSION=10.20.0 \
    VERDACCIO_APP_DIR=/opt/verdaccio \
    VERDACCIO_BUILD_DIR=/opt/verdaccio-build \
    VERDACCIO_PLUGINS_DIR=/opt/verdaccio-plugins \
    VERDACCIO_USER_NAME=verdaccio \
    VERDACCIO_USER_UID=10001 \
    VERDACCIO_PORT=4873 \
    VERDACCIO_PROTOCOL=http \
    VERDACCIO_ADDRESS=0.0.0.0
ENV PATH=$VERDACCIO_APP_DIR/docker-bin:$PATH \
    HOME=$VERDACCIO_APP_DIR

# https://github.com/Yelp/dumb-init
RUN apk --no-cache add openssl dumb-init

WORKDIR $VERDACCIO_APP_DIR

RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate

# Copy only package files to benefit from Docker cache
COPY .babelrc ./
COPY pnpm-lock.yaml ./ 
COPY pnpm-workspace.yaml ./
COPY tsconfig.base.json ./
COPY tsconfig.reference.json ./
COPY package.json ./
COPY packages/ ./packages/
COPY docker-bin/ ./docker-bin/

# Remove development-only packages before installing dependencies
# This prevents pnpm from installing dependencies for test/tool packages
RUN rm -rf ./packages/tools ./packages/standalone

# Only install production dependencies (omit devDependencies)
# ISSUE: pnpm --prod in workspaces still processes ALL workspace packages and installs
# dependencies for all of them. Even though root devDependencies are excluded, some may
# still appear if workspace packages have transitive dependencies or if pnpm needs them
# for workspace resolution. This is a known limitation of pnpm workspaces with --prod.
RUN pnpm config set registry $VERDACCIO_BUILD_REGISTRY && \
    pnpm install --frozen-lockfile --prod --no-optional --ignore-scripts --filter "./packages/**"

# Copy build artifacts
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/api/build ./packages/api/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/auth/build ./packages/auth/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/cli/build ./packages/cli/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/cli/bin ./packages/cli/bin
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/config/build ./packages/config/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/core/core/build ./packages/core/core/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/core/file-locking/build ./packages/core/file-locking/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/core/i18n/build ./packages/core/i18n/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/core/tarball/build ./packages/core/tarball/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/core/url/build ./packages/core/url/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/hooks/build ./packages/hooks/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/loaders/build ./packages/loaders/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/logger/logger/build ./packages/logger/logger/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/logger/logger-commons/build ./packages/logger/logger-commons/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/logger/logger-prettify/build ./packages/logger/logger-prettify/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/middleware/build ./packages/middleware/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/node-api/build ./packages/node-api/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/plugins/audit/build ./packages/plugins/audit/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/plugins/htpasswd/build ./packages/plugins/htpasswd/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/plugins/local-storage/build ./packages/plugins/local-storage/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/plugins/ui-theme/config ./packages/plugins/ui-theme/config
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/plugins/ui-theme/static ./packages/plugins/ui-theme/static
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/proxy/build ./packages/proxy/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/search/build ./packages/search/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/search-indexer/build ./packages/search-indexer/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/server/express/build ./packages/server/express/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/signature/build ./packages/signature/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/standalone/bin ./packages/standalone/bin
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/standalone/build.js ./packages/standalone/build.js
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/store/build ./packages/store/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/ui-components/build ./packages/ui-components/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/ui-components/public ./packages/ui-components/public
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/utils/build ./packages/utils/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/verdaccio/bin ./packages/verdaccio/bin
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/verdaccio/build ./packages/verdaccio/build
COPY --from=builder $VERDACCIO_BUILD_DIR/packages/web/build ./packages/web/build

# Prepare Verdaccio directories
RUN mkdir -p /verdaccio/storage /verdaccio/plugins /verdaccio/conf

# Copy plugins and config
COPY --from=plugins $VERDACCIO_PLUGINS_DIR /verdaccio/plugins
COPY abappm/conf /verdaccio/conf
COPY abappm/i18n $VERDACCIO_APP_DIR/packages/core/i18n/build/download_translations

# Clean up
RUN rm ./pnpm-lock.yaml ./pnpm-workspace.yaml && \
    rm -rf ./.cache && \
    rm -rf ./packages/standalone && \
    rm -rf ./packages/tools && \
    rm -rf /opt/yarn-v1.22.22

RUN find . -type f -a \( -name ".*" -o -name "*.md" -o -name "LICENSE" -o -name "tsconfig.*" -o -name "vitest.*" -o -name "*.d.ts" -o -name "*.js.map" -o -name "typedoc.*" -o -name "webpack.*" \) -delete && \
    find . -type d -a \( -name "examples" -o -name "src" -o -name "test" -o -name "tests" -o -name "tools" -o -name "types" -o -name "vitest" -o -name "__partials__"  -o -name "__snapshots__" \) -not -path "*/node_modules/*" | xargs rm -rf

# Set user, permissions, ownership
RUN adduser -u $VERDACCIO_USER_UID -S -D -h $VERDACCIO_APP_DIR -g "$VERDACCIO_USER_NAME user" -s /sbin/nologin $VERDACCIO_USER_NAME && \
    chmod -R +x $VERDACCIO_APP_DIR/packages/verdaccio/bin $VERDACCIO_APP_DIR/docker-bin && \
    chown -R $VERDACCIO_USER_UID:root /verdaccio/storage /verdaccio/plugins /verdaccio/conf && \
    chmod -R g=u /verdaccio/storage /verdaccio/plugins /verdaccio/conf /etc/passwd

# For monitoring disk space
RUN apk add --no-cache ncdu

USER $VERDACCIO_USER_UID

EXPOSE $VERDACCIO_PORT

VOLUME /verdaccio/storage

ENTRYPOINT ["uid_entrypoint"]

CMD $VERDACCIO_APP_DIR/packages/verdaccio/bin/verdaccio --config /verdaccio/conf/config.yaml --listen $VERDACCIO_PROTOCOL://$VERDACCIO_ADDRESS:$VERDACCIO_PORT
