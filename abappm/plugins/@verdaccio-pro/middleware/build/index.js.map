{"version":3,"sources":["../src/index.ts","../src/plugin.ts","../src/middlewares/security-headers.ts","../src/middlewares/block-requests.ts","../src/middlewares/redirect-npm.ts","../src/middlewares/prototype-pollution.ts"],"sourcesContent":["import MiddlewarePlugin, { MiddlewareConfig } from './plugin'\n\nexport { MiddlewarePlugin }\nexport type { MiddlewareConfig }\nexport default MiddlewarePlugin\n","import buildDebug from 'debug'\nimport { Express } from 'express'\n\nimport { pluginUtils } from '@verdaccio/core'\nimport { Config, Logger } from '@verdaccio/types'\n\nimport { setSecurityHeaders, blockUnwantedRequests, redirectNpmStyleUrl, prototypePollutionProtection } from './middlewares'\n\nconst debug = buildDebug('verdaccio:plugin:pro:middleware')\n\nexport interface MiddlewareConfig {\n  enabled: boolean\n}\n\nclass MiddlewarePlugin\n  extends pluginUtils.Plugin<MiddlewareConfig>\n  implements pluginUtils.ExpressMiddleware<MiddlewareConfig, pluginUtils.Storage<MiddlewareConfig>, pluginUtils.Auth<MiddlewareConfig>> {\n  public config: Config\n  public logger: Logger\n  private middlewareConfig: MiddlewareConfig\n\n  public constructor(config: MiddlewareConfig, options: pluginUtils.PluginOptions) {\n    super(config, options)\n    this.config = options.config\n    this.logger = options.logger\n    this.middlewareConfig = config\n  }\n\n  public register_middlewares(\n    app: Express,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _auth: pluginUtils.Auth<MiddlewareConfig>,\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _storage: pluginUtils.Storage<MiddlewareConfig>,\n  ): void {\n    if (!this.middlewareConfig.enabled) {\n      return\n    }\n    debug('Verdaccio Pro Middleware plugin is enabled')\n\n    app.use(prototypePollutionProtection(this.config))\n    app.use(setSecurityHeaders)\n    app.use(blockUnwantedRequests)\n    app.use('/package', redirectNpmStyleUrl(this.logger))\n  }\n}\n\nexport default MiddlewarePlugin\n","import { Request, Response, NextFunction } from 'express'\n\n// Set security headers for all responses\nconst setSecurityHeaders = (req: Request, res: Response, next: NextFunction): void => {\n  // Allow CORS from any origin for API and web access\n  const origin = req.get('Origin')\n  if (origin) {\n    res.setHeader('Access-Control-Allow-Origin', origin)\n    res.setHeader('Access-Control-Allow-Credentials', 'true')\n  }\n  else {\n    res.setHeader('Access-Control-Allow-Origin', '*')\n  }\n  // Allow essential methods for npm registry operations\n  res.setHeader('Access-Control-Allow-Methods', 'GET, HEAD, PUT, POST, DELETE, OPTIONS')\n  // Allow common headers needed for API access\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin')\n  // Expose headers that may be needed by clients\n  res.setHeader('Access-Control-Expose-Headers', 'Content-Length, Content-Type, ETag, Last-Modified')\n  // Cache preflight requests for 24 hours\n  res.setHeader('Access-Control-Max-Age', '86400')\n\n  // Handle preflight requests\n  if (req.method === 'OPTIONS') {\n    res.status(204).end()\n    return\n  }\n\n  if (req.protocol === 'https' || req.get('X-Forwarded-Proto') === 'https') {\n    // TODO: increase max-age from 1 hour to 31536000 (1 year)\n    res.setHeader('Strict-Transport-Security', 'max-age=86400; includeSubDomains; preload')\n  }\n\n  res.setHeader('Content-Security-Policy',\n    'default-src \\'self\\'; '\n    + 'script-src \\'self\\' \\'unsafe-inline\\'; '\n    + 'style-src \\'self\\' \\'unsafe-inline\\'; '\n    + 'img-src \\'self\\' https: data:; '\n    + 'connect-src \\'self\\'; '\n    + 'font-src \\'self\\'; '\n    + 'object-src \\'self\\'; '\n    + 'base-uri \\'self\\'; '\n    + 'frame-ancestors \\'self\\';')\n\n  res.setHeader('Permissions-Policy', 'accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(self), usb=(), fullscreen=(self), vibrate=()')\n  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin')\n  res.setHeader('X-Robots-Tag', 'noindex')\n  res.setHeader('X-Powered-By', 'Verdaccio')\n  next()\n}\n\nexport default setSecurityHeaders\n","import { Request, Response, NextFunction } from 'express'\n\n// Block requests for things that are not here anyway, bye-bye bots\nconst blockUnwantedRequests = (req: Request, res: Response, next: NextFunction): void => {\n  const unwantedPattern = /\\.(php|exe|cmd|ps1|txt|pdf|doc|docx|xls|xlsx|ppt|pptx)$/\n  if (unwantedPattern.test(req.url)) {\n    res.status(404).send('Not Found')\n  }\n  else {\n    next()\n  }\n}\n\nexport default blockUnwantedRequests\n","import buildDebug from 'debug'\nimport { Request, Response, NextFunction } from 'express'\n\nimport { Logger } from '@verdaccio/types'\n\nconst debug = buildDebug('verdaccio:plugin:pro:middleware:redirect')\n\n// Redirect NPM-style URL to web UI\nconst redirectNpmStyleUrl = (logger: Logger) => {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  return (req: Request, res: Response, _next: NextFunction): void => {\n    debug('redirect from %o', req.url)\n    const redirectTo = '/-/web/detail' + req.url\n    logger.info({ redirectTo }, 'Redirecting to @{redirectTo}')\n    debug('redirect to %o', redirectTo)\n    res.redirect(redirectTo)\n  }\n}\n\nexport default redirectNpmStyleUrl\n","import express from 'express'\nimport { Config } from '@verdaccio/types'\n\n// Prevent prototype pollution\n// https://medium.com/@instatunnel/prototype-pollution-the-javascript-vulnerability-that-poisons-your-entire-app-%EF%B8%8F-bad082616771\nconst prototypePollutionProtection = (config: Config): express.RequestHandler => {\n  return express.json({\n    strict: false,\n    limit: config.max_body_size || '10mb',\n    // Explicitly reject __proto__ and constructor\n    verify: (_req, _res, buf) => {\n      const str = buf.toString()\n      if (str.includes('__proto__') || str.includes('constructor')) {\n        throw new Error('Invalid JSON')\n      }\n    },\n  })\n}\n\nexport default prototypePollutionProtection\n"],"mappings":"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","names":["import_debug","buildDebug","express","debug","buildDebug"]}