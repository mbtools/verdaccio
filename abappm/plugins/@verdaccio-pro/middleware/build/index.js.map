{"version":3,"sources":["../src/index.ts","../src/plugin.ts","../src/middlewares/security-headers.ts","../src/middlewares/block-requests.ts","../src/middlewares/redirect-npm.ts"],"sourcesContent":["import MiddlewarePlugin, { MiddlewareConfig } from './plugin'\n\nexport { MiddlewarePlugin }\nexport type { MiddlewareConfig }\nexport default MiddlewarePlugin\n","/* eslint-disable @typescript-eslint/no-unused-vars */\nimport buildDebug from 'debug'\nimport { Express } from 'express'\n\nimport { pluginUtils } from '@verdaccio/core'\nimport { Config, Logger } from '@verdaccio/types'\n\nimport { setSecurityHeaders, blockUnwantedRequests, redirectNpmStyleUrl } from './middlewares'\n\nconst debug = buildDebug('verdaccio:plugin:pro:middleware')\n\nexport interface MiddlewareConfig extends Config {\n  enabled: boolean\n}\n\nclass MiddlewarePlugin\n  extends pluginUtils.Plugin<MiddlewareConfig>\n  implements pluginUtils.ExpressMiddleware<MiddlewareConfig, pluginUtils.Storage<MiddlewareConfig>, pluginUtils.Auth<MiddlewareConfig>> {\n  public config: Config\n  public logger: Logger\n  private pluginConfig: MiddlewareConfig\n\n  public constructor(config: MiddlewareConfig, options: pluginUtils.PluginOptions) {\n    super(config, options)\n    this.config = options.config\n    this.logger = options.logger\n    this.pluginConfig = config\n  }\n\n  public register_middlewares(\n    app: Express,\n    _auth: pluginUtils.Auth<MiddlewareConfig>,\n    _storage: pluginUtils.Storage<MiddlewareConfig>,\n  ): void {\n    if (!this.pluginConfig.enabled) {\n      return\n    }\n    debug('Verdaccio Pro Middleware plugin is enabled')\n\n    app.use(setSecurityHeaders)\n    app.use(blockUnwantedRequests)\n    app.use('/package', redirectNpmStyleUrl(this.logger))\n  }\n}\n\nexport default MiddlewarePlugin\n","import { Request, Response, NextFunction } from 'express'\n\n// Set security headers for all responses\nconst setSecurityHeaders = (_req: Request, res: Response, next: NextFunction): void => {\n  // TODO: increase max-age to 31536000 (1 year)\n  res.setHeader('Strict-Transport-Security', 'max-age=86400; includeSubDomains')\n  res.setHeader('Content-Security-Policy', 'connect-src \\'self\\'; default-src \\'self\\'; object-src \\'none\\'; script-src \\'self\\'')\n  res.setHeader('Permissions-Policy', 'accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(self), usb=(), fullscreen=(self), vibrate=()')\n  res.setHeader('Referrer-Policy', 'no-referrer')\n  res.setHeader('X-Robots-Tag', 'noindex')\n  res.setHeader('X-Powered-By', 'Verdaccio')\n  next()\n}\n\nexport default setSecurityHeaders\n","import { Request, Response, NextFunction } from 'express'\n\n// Block requests for things that are not here anyway, bye-bye bots\nconst blockUnwantedRequests = (req: Request, res: Response, next: NextFunction): void => {\n  const unwantedPattern = /\\.(php|exe|cmd|ps1|txt|pdf|doc|docx|xls|xlsx|ppt|pptx)$/\n  if (unwantedPattern.test(req.url)) {\n    res.status(404).send('Not Found')\n  }\n  else {\n    next()\n  }\n}\n\nexport default blockUnwantedRequests\n","import buildDebug from 'debug'\nimport { Request, Response, NextFunction } from 'express'\n\nimport { Logger } from '@verdaccio/types'\n\nconst debug = buildDebug('verdaccio:plugin:pro:middleware:redirect')\n\n// Redirect NPM-style URL to web UI\nconst redirectNpmStyleUrl = (logger: Logger) => {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  return (req: Request, res: Response, _next: NextFunction): void => {\n    debug('redirect from %o', req.url)\n    const redirectTo = '/-/web/detail' + req.url\n    logger.info({ redirectTo }, 'Redirecting to @{redirectTo}')\n    debug('redirect to %o', redirectTo)\n    res.redirect(redirectTo)\n  }\n}\n\nexport default redirectNpmStyleUrl\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACCA,IAAAA,gBAAuB;AAGvB,kBAA4B;;;ACD5B,IAAM,qBAAqB,CAAC,MAAe,KAAe,SAA6B;AAErF,MAAI,UAAU,6BAA6B,kCAAkC;AAC7E,MAAI,UAAU,2BAA2B,8EAAsF;AAC/H,MAAI,UAAU,sBAAsB,kJAAkJ;AACtL,MAAI,UAAU,mBAAmB,aAAa;AAC9C,MAAI,UAAU,gBAAgB,SAAS;AACvC,MAAI,UAAU,gBAAgB,WAAW;AACzC,OAAK;AACP;AAEA,IAAO,2BAAQ;;;ACXf,IAAM,wBAAwB,CAAC,KAAc,KAAe,SAA6B;AACvF,QAAM,kBAAkB;AACxB,MAAI,gBAAgB,KAAK,IAAI,GAAG,GAAG;AACjC,QAAI,OAAO,GAAG,EAAE,KAAK,WAAW;AAAA,EAClC,OACK;AACH,SAAK;AAAA,EACP;AACF;AAEA,IAAO,yBAAQ;;;ACbf,mBAAuB;AAKvB,IAAM,YAAQ,aAAAC,SAAW,0CAA0C;AAGnE,IAAM,sBAAsB,CAAC,WAAmB;AAE9C,SAAO,CAAC,KAAc,KAAe,UAA8B;AACjE,UAAM,oBAAoB,IAAI,GAAG;AACjC,UAAM,aAAa,kBAAkB,IAAI;AACzC,WAAO,KAAK,EAAE,WAAW,GAAG,8BAA8B;AAC1D,UAAM,kBAAkB,UAAU;AAClC,QAAI,SAAS,UAAU;AAAA,EACzB;AACF;AAEA,IAAO,uBAAQ;;;AHVf,IAAMC,aAAQ,cAAAC,SAAW,iCAAiC;AAM1D,IAAM,mBAAN,cACU,wBAAY,OACkH;AAAA,EAK/H,YAAY,QAA0B,SAAoC;AAC/E,UAAM,QAAQ,OAAO;AACrB,SAAK,SAAS,QAAQ;AACtB,SAAK,SAAS,QAAQ;AACtB,SAAK,eAAe;AAAA,EACtB;AAAA,EAEO,qBACL,KACA,OACA,UACM;AACN,QAAI,CAAC,KAAK,aAAa,SAAS;AAC9B;AAAA,IACF;AACA,IAAAD,OAAM,4CAA4C;AAElD,QAAI,IAAI,wBAAkB;AAC1B,QAAI,IAAI,sBAAqB;AAC7B,QAAI,IAAI,YAAY,qBAAoB,KAAK,MAAM,CAAC;AAAA,EACtD;AACF;AAEA,IAAO,iBAAQ;;;ADzCf,IAAO,gBAAQ;","names":["import_debug","buildDebug","debug","buildDebug"]}